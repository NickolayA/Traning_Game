<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>

    <div id="game">

        <table id="grid">
        </table>

    </div>

    <style>
        #game{
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }
        
        #grid{
            width: 70%;
            height: 70%;
            border-collapse: collapse;
            border-spacing: 0;
            position: relative;
            table-layout: fixed;
        }   

        #grid td{
            border: 1px solid black;
            text-align: right;
            vertical-align: top;
            position: relative;
        }
        #grid tr:nth-last-child(2) td:last-child{
            border-bottom: 0;
        }
        #grid tr:nth-last-child(1) td{
            border: none;
        }

        #grid tr:last-child td:nth-last-child(1){
            
        }
        
        #character{
            background-color: rgba(150, 150, 150, 0.2);
            position: absolute;
            z-index: 5;
            text-align: center;
            vertical-align: middle;
            border: 1xp solid red;
            width: 100%;
            height: 100%;
        }


    </style>

    <script type="text/javascript">
        var heightCountSquares = 2 + (1);
        var widthCountSquares = 2;


        var grid = "";
        for (var i = 0; i < heightCountSquares; i++) {
            grid += "<tr>";
            for (var j = 0; j < widthCountSquares; j++) {
                grid += "<td>" + 10 + "</td>";
            }
            grid += "</tr>";
        }

        document.getElementById("grid").innerHTML = grid;

        // // Grid class constructor
        // function Grid(name) {
        //     this.name = name;
        // }
        // Grid.prototype.createGrid = function () {
        //     return this.name;
        // }

        // var grid = new Grid("JOhn");
        // console.log(grid.createGrid());

        var game = document.getElementById("game");

        // var characterClass = {
        //     width: 0.7 * game.offsetWidth / widthCountSquares,
        //     height: 0.7 * game.offsetHeight / heightCountSquares,
        //     createCharacter: function () {
        //         var character = document.createElement('div');
        //         character.setAttribute("id", "character");
        //         character.style.width = "100%";
        //         character.style.height = "100%";
        //         character.style.top = "0px";
        //         character.style.left = "0px";
        //         character.innerText = 0;

        //         return character;
        //     }
        // };

        // Character class
        function Character(startPositionX, startPositionY, maxCountOfBoxes) {
            this.positionX = startPositionX;
            this.positionY = startPositionY;
            this.maxCountOfBoxes = maxCountOfBoxes;
            this.currentCountOfBoxes = 0;
            this.createCharacter();
        }

        Character.prototype.createCharacter = function () {
            var character = document.createElement('div');
            character.setAttribute("id", "character");
            character.style.width = "100%";
            character.style.height = "100%";
            character.style.top = "0px";
            character.style.left = "0px";
            character.innerText = 0;
            this.character = character;
        }

        Character.prototype.addBox = function () {
            if (this.currentCountOfBoxes < this.maxCountOfBoxes) {
                this.currentCountOfBoxes += 1;
                this.character.innerText = this.currentCountOfBoxes;
            }
        }

        Character.prototype.removeBox = function () {
            if (this.currentCountOfBoxes > 0) {
                this.currentCountOfBoxes -= 1;
                this.character.innerText = this.currentCountOfBoxes;
            }
        }

        Character.prototype.getCurrentPosition = function () {
            return {
                currentPositionX: this.positionX,
                currentPositionY: this.positionY
            }
        }

        Character.prototype.moveCharacter = function (newPositionX, newPositionY) {

            this.positionX = newPositionX;
            this.positionY = newPositionY;
        }

        Character.prototype.getCountOfBoxes = function () {
            return this.currentCountOfBoxes;
        }






        var grid = document.getElementById("grid");
        //var character = characterClass.createCharacter();
        var character = new Character(widthCountSquares - 1, heightCountSquares - 1, 5);
        var tds = grid.getElementsByTagName('td');
        //tds[widthCountSquares * (heightCountSquares + 1) - 1].appendChild(character);

        var currentPositionX = widthCountSquares - 1;
        var currentPositionY = heightCountSquares - 1;
        tds[currentPositionY * widthCountSquares + currentPositionX].appendChild(character.character);



        document.onkeydown = function (e) {


            let {
                currentPositionX,
                currentPositionY
            } = character.getCurrentPosition();

            console.log("start", currentPositionX, currentPositionY);

            switch (e.keyCode) {

                case 37: // Left
                    if (currentPositionX != 0 && currentPositionY !=
                        heightCountSquares + 1 && currentPositionY != heightCountSquares - 1) {
                        character.character.parentNode.removeChild(character.character);
                        currentPositionX -= 1;
                        character.moveCharacter(currentPositionX, currentPositionY);
                        tds[currentPositionY * widthCountSquares + currentPositionX].appendChild(character
                            .character);
                    }

                    break;
                case 38: // Up
                    if (currentPositionY != 0) {
                        character.character.parentNode.removeChild(character.character);
                        currentPositionY -= 1;
                        character.moveCharacter(currentPositionX, currentPositionY);
                        console.log(currentPositionX, currentPositionY);
                        tds[currentPositionY * widthCountSquares + currentPositionX].appendChild(character.character);
                    }

                    break;
                case 39:
                    if (currentPositionX != widthCountSquares - 1) {
                        character.character.parentNode.removeChild(character.character);
                        currentPositionX += 1;
                        character.moveCharacter(currentPositionX, currentPositionY);

                        tds[currentPositionY * widthCountSquares + currentPositionX].appendChild(character.character);
                    }

                    break;
                case 40:
                    if (currentPositionY != heightCountSquares - 1 && currentPositionX == widthCountSquares - 1) {
                        character.character.parentNode.removeChild(character.character);
                        currentPositionY += 1;
                        character.moveCharacter(currentPositionX, currentPositionY);

                        tds[currentPositionY * widthCountSquares + currentPositionX].appendChild(character.character);
                    } else if (currentPositionY != heightCountSquares - 2 && currentPositionX != widthCountSquares -
                        1) {
                        character.character.parentNode.removeChild(character.character);
                        currentPositionY += 1;
                        character.moveCharacter(currentPositionX, currentPositionY);

                        tds[currentPositionY * widthCountSquares + currentPositionX].appendChild(character.character);
                    }
                    break;
                case 32:
                    var positionIndex = currentPositionY * widthCountSquares + currentPositionX;

                    if (positionIndex == widthCountSquares * heightCountSquares - 1) {
                        // On Exit position
                        //var countOfBoxes = parseInt(character.removeBox());
                        if (character.getCountOfBoxes() != 0) {
                            console.log(character.getCountOfBoxes());
                            tds[positionIndex].innerText = parseInt(tds[positionIndex].innerHTML) + 1;
                            character.removeBox();
                            tds[positionIndex].appendChild(character.character);
                            console.log("Exit")
                        }
                    } else {
                        // In storages
                        var countOfBoxes = parseInt(tds[positionIndex].innerHTML);
                        if (countOfBoxes != 0) {
                            tds[positionIndex].innerText = countOfBoxes - 1;
                            character.addBox();
                            console.log(character.getCountOfBoxes());
                            tds[positionIndex].appendChild(character.character);

                        }
                    }
            }

        }
    </script>
</body>

</html>