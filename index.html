<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>

<body>

    <div id="game">
        <!-- <div id="welcomeForm">

        </div> -->
        <!-- <table id="grid">
        </table> -->

    </div>

    <style>

        #welcomeForm{
            position: absolute;
            top: 50%;
            left: 50%;
            width: 200px;
            height: 200px;
            background-color: aqua;
            display: none;
        }

        #game{
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        #grid{
            width: 70%;
            height: 70%;
            border-collapse: collapse;
            border-spacing: 0;
            position: relative;
            table-layout: fixed;
        }   

        #grid td{
            border: 1px solid black;
            text-align: right;
            vertical-align: top;
            position: relative;
            z-index: 5;
        }
        #grid tr:nth-last-child(2) td:last-child{
            border-bottom: 0;
        }
        #grid tr:nth-last-child(1) td{
            border: none;
        }

        #grid tr:last-child td:nth-last-child(1){
            
        }
        
        #character{
            background-color: rgba(150, 150, 150, 0.2);
            position: absolute;
            text-align: center;
            vertical-align: middle;
            border: 1xp solid red;
            width: 100%;
            height: 100%;
            
        }


    </style>

    <script type="text/javascript">
        // Character class
        function Character(startPositionX, startPositionY, maxCountOfBoxes) {
            this.positionX = startPositionX;
            this.positionY = startPositionY;
            this.maxCountOfBoxes = maxCountOfBoxes;
            this.currentCountOfBoxes = 0;
            this.createCharacter();
        }

        Character.prototype.createCharacter = function () {
            var character = document.createElement('div');
            character.setAttribute("id", "character");
            character.style.width = "100%";
            character.style.height = "100%";
            character.style.top = "0px";
            character.style.left = "0px";
            character.innerText = 0;
            this.character = character;
        }

        Character.prototype.addBox = function () {
            if (this.currentCountOfBoxes < this.maxCountOfBoxes) {
                this.currentCountOfBoxes += 1;
                this.character.innerText = this.currentCountOfBoxes;
            }
        }

        Character.prototype.removeBox = function () {
            if (this.currentCountOfBoxes > 0) {
                this.currentCountOfBoxes -= 1;
                this.character.innerText = this.currentCountOfBoxes;
            }
        }

        Character.prototype.getCurrentPosition = function () {
            return {
                currentPositionX: this.positionX,
                currentPositionY: this.positionY
            }
        }

        Character.prototype.moveCharacter = function (newPositionX, newPositionY) {

            this.positionX = newPositionX;
            this.positionY = newPositionY;
        }

        Character.prototype.getCountOfBoxes = function () {
            return this.currentCountOfBoxes;
        }

        Character.prototype.getCharacter = function () {
            // make function and change character.character to character.getCharacter()
            return this.character;
        }
        // end character class

        // Storage class
        function Storage(positionIndex, maxCountOfBoxes, currentCountOfBoxes) {
            this.positionIndex = positionIndex;
            this.maxCountOfBoxes = maxCountOfBoxes;
            this.currentCountOfBoxes = currentCountOfBoxes;
            this.createStorage();
        }

        Storage.prototype = Object.create(Character.prototype);
        //Storage.prototype = new Character(1, 2, 3);

        Storage.prototype.createStorage = function () {
            var storage = document.createElement('td');
            storage.setAttribute("class", "storage");
            storage.innerText = this.currentCountOfBoxes;
            this.storage = storage;
        }

        Storage.prototype.removeBox = function () {
            if (this.currentCountOfBoxes > 0) {
                this.currentCountOfBoxes -= 1;
                this.storage.innerText = this.currentCountOfBoxes;
            }
        }

        Storage.prototype.getStorage = function () {
            return this.storage;
        }
        // end storage class

        // class Grid
        function Grid(heightCountSquares, widthCountSquares, storages, character) {
            // check if storageCount <= heightCountSquares * widthCountSquares
            this.heightCountSquares = heightCountSquares;
            this.widthCountSquares = widthCountSquares;
            this.storages = storages;
            this.character = character;
            this.grid = null;
            this.createGrid();
        }

        Grid.prototype.createGrid = function () {

            var grid = document.createElement("table");
            grid.setAttribute("id", "grid");

            for (var i = 0; i < this.heightCountSquares; i++) {
                //create tr element
                var tr = document.createElement('tr');
                grid.appendChild(tr);

                for (var j = 0; j < this.widthCountSquares; j++) {
                    if (i == this.heightCountSquares - 1 && j == this.widthCountSquares - 1) {
                        var td = document.createElement("td");
                        td.innerText = 0;
                        td.appendChild(this.character.getCharacter());
                        tr.appendChild(td);
                    } else if (this.storages[i * this.widthCountSquares + j] == undefined) {
                        tr.appendChild(document.createElement("td"));
                    } else {
                        tr.appendChild(this.storages[i * this.widthCountSquares +
                                j]
                            .getStorage());
                    }
                }
            }

            this.grid = grid;
        }

        Grid.prototype.getGrid = function () {
            return this.grid;
        }
        // end class Grid

        // class Game
        function Game(heightCountSquares, widthCountSquares, storagesCount, maxCountOfBoxesPerStorage,
            maxCountOfBoxesPerCharacter) {

            // check if storageCount <= heightCountSquares * widthCountSquares
            this.storages = [];
            this.heightCountSquares = heightCountSquares + 1;
            this.widthCountSquares = widthCountSquares;
            this.storagesCount = storagesCount;
            this.maxCountOfBoxesPerStorage = maxCountOfBoxesPerStorage;
            this.maxCountOfBoxesPerCharacter = maxCountOfBoxesPerCharacter;
            this.countOfAllBoxes = 0;

            this.grid = null;
            this.storages = [];
            this.character = null;
            this.createStorages();
            this.createCharacter();
            this.createGrid();
            this.createGame();

        }

        Game.prototype.showWelcomeForm = function () {
            var welcomeForm = document.getElementById("welcomeForm");
            welcomeForm.style.display = "block";
        }

        Game.prototype.hideWelcomeForm = function () {
            var welcomeForm = document.getElementById("welcomeForm");
            welcomeForm.style.display = none;
        }

        Game.prototype.createStorages = function () {
            var randomPositions = [];
            var countOfSquares = this.widthCountSquares * (this.heightCountSquares - 1);

            while (randomPositions.length < this.storagesCount) {
                var randomNumber = Math.floor(Math.random() * countOfSquares);
                if (randomPositions.indexOf(randomNumber) > -1) continue;
                randomPositions[randomPositions.length] = randomNumber;
            }

            for (var randomPosition of randomPositions) {
                var countOfBoxesPerStorage = Math.floor(Math.random() * this.maxCountOfBoxesPerStorage) + 1;
                this.storages[randomPosition] = countOfBoxesPerStorage;

            }

            var that = this;
            this.storages = this.storages.map(function (countOfBoxesPerStorage, index) {
                if (countOfBoxesPerStorage != "undefined") {
                    that.countOfAllBoxes += countOfBoxesPerStorage;
                    return new Storage(index, that.maxCountOfBoxesPerStorage,
                        countOfBoxesPerStorage);
                }
            });
        }

        Game.prototype.createGrid = function () {
            this.grid = new Grid(this.heightCountSquares, this.widthCountSquares, this.storages, this.character);

        }

        Game.prototype.createCharacter = function () {
            this.character = new Character(this.widthCountSquares - 1, this.heightCountSquares - 1, this.maxCountOfBoxesPerCharacter);
        }

        Game.prototype.createGame = function () {
            document.getElementById("game").appendChild(this.grid.getGrid());
            var that = this;
            var tds = document.getElementsByTagName('td');
            document.onkeydown = function (e) {


                let {
                    currentPositionX,
                    currentPositionY
                } = that.character.getCurrentPosition();



                switch (e.keyCode) {

                    case 37: // Left
                        if (currentPositionX != 0 && currentPositionY !=
                            that.heightCountSquares + 1 && currentPositionY != that.heightCountSquares - 1) {
                            that.character.getCharacter().parentNode.removeChild(that.character.getCharacter());
                            currentPositionX -= 1;
                            that.character.moveCharacter(currentPositionX, currentPositionY);
                            tds[currentPositionY * that.widthCountSquares + currentPositionX].appendChild(that.character
                                .getCharacter());
                        }

                        break;
                    case 38: // Up
                        if (currentPositionY != 0) {
                            that.character.getCharacter().parentNode.removeChild(that.character.getCharacter());
                            currentPositionY -= 1;
                            that.character.moveCharacter(currentPositionX, currentPositionY);

                            tds[currentPositionY * that.widthCountSquares + currentPositionX].appendChild(that.character
                                .getCharacter());
                        }

                        break;
                    case 39:
                        if (currentPositionX != that.widthCountSquares - 1) {
                            that.character.getCharacter().parentNode.removeChild(that.character.getCharacter());
                            currentPositionX += 1;
                            that.character.moveCharacter(currentPositionX, currentPositionY);

                            tds[currentPositionY * that.widthCountSquares + currentPositionX].appendChild(that.character
                                .getCharacter());
                        }

                        break;
                    case 40:
                        if (currentPositionY != that.heightCountSquares - 1 && currentPositionX == that.widthCountSquares -
                            1) {
                            that.character.getCharacter().parentNode.removeChild(that.character.getCharacter());
                            currentPositionY += 1;
                            that.character.moveCharacter(currentPositionX, currentPositionY);

                            tds[currentPositionY * that.widthCountSquares + currentPositionX].appendChild(that.character
                                .getCharacter());
                        } else if (currentPositionY != that.heightCountSquares - 2 && currentPositionX !=
                            that.widthCountSquares -
                            1) {
                            that.character.getCharacter().parentNode.removeChild(that.character.getCharacter());
                            currentPositionY += 1;
                            that.character.moveCharacter(currentPositionX, currentPositionY);

                            tds[currentPositionY * that.widthCountSquares + currentPositionX].appendChild(that.character
                                .getCharacter());
                        }
                        break;
                    case 32:
                        var positionIndex = currentPositionY * that.widthCountSquares + currentPositionX;

                        if (positionIndex == that.widthCountSquares * that.heightCountSquares - 1) {

                            // On Exit position
                            if (that.character.getCountOfBoxes() > 0) {
                                var countOfBoxesOnExit = parseInt(tds[positionIndex].innerHTML);
                                tds[positionIndex].innerText = countOfBoxesOnExit + 1;
                                that.character.removeBox();
                                tds[positionIndex].appendChild(that.character.getCharacter());

                                if (countOfBoxesOnExit + 1 == that.countOfAllBoxes) {
                                    alert("You win");
                                }
                            }
                        } else if (tds[positionIndex].classList.contains('storage')) {
                            // In storages

                            var countOfBoxes = that.storages[positionIndex].getCountOfBoxes();

                            if (countOfBoxes > 0 && that.character.getCountOfBoxes() < that.maxCountOfBoxesPerCharacter) {
                                that.storages[positionIndex].removeBox();
                                that.character.addBox();
                                tds[positionIndex].appendChild(that.character.getCharacter());
                            }
                        }
                }

            }

        }
        // end class
        var game = new Game(5, 6, 3, 4, 3);
    </script>
</body>

</html>